// Prisma schema for HENRYS application

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}


enum Role {
  GUEST
  APPLICANT
  MEMBER
  HOST
  ADMIN
}

enum ApplicationStatus {
  SUBMITTED
  IN_REVIEW
  WAITLIST
  APPROVED
  REJECTED
}

model User {
  id             String           @id @default(cuid())
  email          String           @unique
  emailVerified  DateTime?
  name           String?
  image          String?
  role           Role             @default(GUEST)
  passwordHash   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  memberProfile  MemberProfile?
  applications   Application[]    @relation("ApplicantSubmissions")
  reviews        Application[]    @relation("ApplicationReviews")
  sessions       Session[]
  accounts       Account[]
  inviteCodes    InviteCode[]     @relation("InviteCreator")
  redeemedInvites InviteCode[]    @relation("InviteRedeemer")
  subscriptions  Subscription[]
  payments       Payment[]
  eventRsvps     EventRsvp[]
  auditLogs      AuditLog[]       @relation("AuditLogActor")
  applicantProfile Applicant?
  hostedEvents   Event[]          @relation("EventHost")
}

model Application {
  id          String             @id @default(cuid())
  email       String
  fullName    String
  status      ApplicationStatus  @default(SUBMITTED)
  createdAt   DateTime           @default(now())
  reviewedAt  DateTime?
  reviewerId  String?
  reviewer    User?              @relation("ApplicationReviews", fields: [reviewerId], references: [id])
  applicantId String?
  applicant   User?              @relation("ApplicantSubmissions", fields: [applicantId], references: [id])
  notes       String?
  payload     Json
  inviteCodes InviteCode[]

  @@index([email])
  @@map("applications")
}

model Applicant {
  id              String    @id @default(cuid())
  fullName        String
  email           String    @unique
  userId          String?   @unique
  user            User?     @relation(fields: [userId], references: [id])
  age             Int
  city            String
  occupation      String
  linkedin        String?
  instagram       String?
  vibe            Int
  motivation      String
  threeWords      String
  perfectSaturday String
  dietary         String?
  dietaryNotes    String?
  alcohol         String
  availability    String?
  dealBreakers    String[]  @default([])
  consentCode     Boolean
  consentData     Boolean
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model MemberProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id])
  fullName              String
  age                   Int?
  city                  String?
  occupation            String?
  linkedinUrl           String?
  instagramUrl          String?
  about                 String?
  threeWords            String?
  perfectSaturday       String?
  dietaryPreferences    String?
  alcoholPreferences    String?
  vibeEnergy            Int?
  dealBreakers          String[]  @default([])
  personalityTags       String[]  @default([])
  dietaryNotes          String?
  availabilityWindows   Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model InviteCode {
  id             String     @id @default(cuid())
  code           String     @unique
  applicationId  String?
  application    Application? @relation(fields: [applicationId], references: [id])
  createdById    String?
  createdBy      User?      @relation("InviteCreator", fields: [createdById], references: [id])
  userId         String?
  user           User?      @relation("InviteRedeemer", fields: [userId], references: [id])
  expiresAt      DateTime?
  redeemedAt     DateTime?
  createdAt      DateTime   @default(now())
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Event {
  id            String    @id @default(cuid())
  slug          String    @unique
  name          String
  summary       String
  startAt       DateTime
  endAt         DateTime
  venue         String?
  venueName     String?
  venueAddress  String?
  venueNotes    String?
  venueHiddenUntil DateTime?
  capacity      Int       @default(40)
  details       String?
  visibility    Boolean   @default(true)
  priceCents    Int       @default(0)
  currency      String    @default("usd")
  rsvpDeadline  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  rsvps         EventRsvp[]
  seatGroups    SeatGroup[]
  payments      Payment[]
  hostId        String?
  host          User?     @relation("EventHost", fields: [hostId], references: [id])
}

model HomepageCarouselImage {
  id        String   @id @default(cuid())
  imageUrl  String
  altText   String?
  isVisible Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MembershipPlan {
  id            String         @id @default(cuid())
  name          String
  stripePriceId String         @unique
  perksJSON     Json
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String
  planId           String
  status           String
  currentPeriodEnd DateTime?
  stripeCustomerId String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
  plan             MembershipPlan @relation(fields: [planId], references: [id])
}

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  eventId               String?
  amount                Int
  currency              String
  status                String
  stripePaymentIntentId String   @unique
  receiptUrl            String?
  description           String?
  createdAt             DateTime @default(now())
  user                  User     @relation(fields: [userId], references: [id])
  event                 Event?   @relation(fields: [eventId], references: [id])
}

enum RsvpStatus {
  GOING
  WAITLISTED
  CANCELED
}

model EventRsvp {
  id        String     @id @default(cuid())
  userId    String
  eventId   String
  status    RsvpStatus @default(WAITLISTED)
  seatGroupId String?
  preferences Json?
  noShow    Boolean    @default(false)
  attended  Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id])
  event     Event      @relation(fields: [eventId], references: [id])
  seatGroup SeatGroup? @relation(fields: [seatGroupId], references: [id])

  @@unique([userId, eventId])
}

model SeatGroup {
  id          String     @id @default(cuid())
  eventId     String
  tableNumber Int
  capacity    Int        @default(6)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  event       Event      @relation(fields: [eventId], references: [id])
  rsvps       EventRsvp[]

  @@index([eventId, tableNumber])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  actorEmail String?
  action     String
  targetType String
  targetId   String
  diffJSON   Json
  createdAt  DateTime @default(now())
  actor      User?    @relation("AuditLogActor", fields: [actorId], references: [id])

  @@index([targetType, targetId])
  @@index([createdAt])
}
